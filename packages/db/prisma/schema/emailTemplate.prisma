// ============================================================================
// EMAIL TEMPLATE
// ============================================================================
// Email templates with MJML content that can reference EmailComponents via {{component:slug}}.
// Supports polymorphic ownership: default (all tenants), admin (platform), Organization (tenant-branded)

model EmailTemplate {
  id        String              @id @default(dbgenerated("uuidv7()")) @db.VarChar(36)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  name     String               // "OTP Verification"
  slug     String               // "otp"
  locale   String               @default("en")
  category CommunicationCategory

  subject String                // "Your verification code: {{code}}"
  mjml    String  @db.Text      // Full MJML with {{component:slug}} and {{variable.*}} placeholders

  // Pre-computed component refs (populated on save)
  componentRefs String[]        // Slugs of nested {{component:slug}} references

  // Owner (false polymorphism - default/admin have no FK)
  ownerModel     EmailOwnerModel @default(default)
  organizationId String?         @db.VarChar(36)
  spaceId        String?         @db.VarChar(36)

  // For org-owned: should spaces inherit this template?
  inheritToSpaces Boolean @default(true)

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  space        Space?        @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([slug, locale, ownerModel, organizationId, spaceId])
  @@index([category])
  @@index([ownerModel])
  @@index([organizationId])
}

enum CommunicationCategory {
  system      // OTP, password reset, security alerts - cannot unsubscribe
  promotional // Marketing, newsletters - can unsubscribe
}
